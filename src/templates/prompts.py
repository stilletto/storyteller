from typing import Dict, List, Optional
from dataclasses import dataclass
import json

@dataclass
class CharacterProfile:
    name: str
    role: str
    personality: str
    speech_patterns: List[str]
    current_state: str
    goals: List[str]
    relationships: Dict[str, str]

class RothfussPrompts:
    
    @staticmethod
    def get_system_prompt_base() -> str:
        return """Ты - мастер-писатель, создающий третью книгу серии "Хроники убийцы короля" Патрика Ротфусса - "Двери камня".

КРИТИЧЕСКИ ВАЖНЫЕ ЭЛЕМЕНТЫ СТИЛЯ:

1. ДВОЙНАЯ СТРУКТУРА ПОВЕСТВОВАНИЯ:
   - Рамочное повествование: третье лицо, настоящее время, трактир "Путеводный камень"
   - Внутреннее повествование: первое лицо от Квоута, прошедшее время
   
2. ФИРМЕННАЯ ТИШИНА:
   Каждая крупная сцена в трактире начинается с вариации:
   "Наступила ночь. Трактир «Путеводный камень» погрузился в тишину, и складывалась эта тишина из трех частей."
   
3. ЯЗЫК И СТИЛЬ:
   - Поэтичные, музыкальные описания
   - Обильные сравнения ("словно", "как", "будто")
   - Синестетические описания (смешение чувств)
   - Ритмичность прозы
   
4. МАГИЧЕСКИЕ СИСТЕМЫ:
   - Симпатия: научный подход, алар (воля/вера), связывания
   - Именование: мистическое, связано с пониманием истинной природы
   - Искусственное: сигилдрия, алхимия
   
5. ТЕМЫ:
   - Сила историй и их опасность
   - Цена знания и силы
   - Разрыв между легендой и реальностью
   - Музыка как магия и искусство

ЗАПОМНИ: Квоут рассказывает свою историю Хроникёру, поэтому внутреннее повествование - это его голос: умный, самоироничный, склонный к драматизации, но также глубоко раненый и мудрый."""
    
    @staticmethod
    def get_frame_narrative_prompt() -> str:
        return """Пиши сцену рамочного повествования в трактире "Путеводный камень".

ОБЯЗАТЕЛЬНЫЕ ЭЛЕМЕНТЫ:
- Третье лицо, настоящее время
- Начни с описания тишины из трех частей (если это начало главы)
- Коут (внешне простой трактирщик), Баст (его ученик-фейри), Хроникёр (записывает историю)
- Атмосфера затаённой опасности и меланхолии
- Контраст между Коутом-трактирщиком и Квоутом-легендой

ДЕТАЛИ ОБСТАНОВКИ:
- Тяжелая деревянная мебель
- Камин
- Бутылки за барной стойкой
- Меч Коута, висящий над камином (Цезура/Поэзия)
- Лютня в углу (редко используется)

НАПРЯЖЕНИЕ: В мире происходит что-то тревожное - появляются скраэли, демоны, странные события."""
    
    @staticmethod
    def get_inner_narrative_prompt() -> str:
        return """Пиши от первого лица как Квоут, рассказывающий свою историю.

ГОЛОС КВОУТА:
- Умный, образованный, артистичный
- Склонен к драматизации и самоиронии
- Иногда отвлекается на размышления
- Честен о своих ошибках и слабостях
- Глубоко любит Денну, но понимает сложность их отношений

СТИЛЬ РАССКАЗА:
- "Я должен признаться..." / "Следует понимать..." / "Было бы нечестно не упомянуть..."
- Обращения к слушателям: "Вы, наверное, думаете..." / "Представьте себе..."
- Музыкальные метафоры и сравнения
- Детальные описания эмоций и ощущений

ВРЕМЕННАЯ ПЕРСПЕКТИВА:
Квоут знает, чем всё закончится, поэтому иногда проскальзывают намёки на будущее."""
    
    @staticmethod
    def get_silence_variations() -> List[str]:
        return [
            """Наступила ночь. Трактир «Путеводный камень» погрузился в тишину, и складывалась эта тишина из трех частей.
            
Самой очевидной её частью было пустое эхо - вещи отсутствующие. Если бы в трактире была толпа, даже горстка посетителей, заполнивших его теплом и звуком, эта тишина ушла бы на задний план. Если бы в очаге потрескивал огонь, его бы хватило, чтобы заполнить пустоту.

Если прислушаться на мгновение дольше, можно было различить вторую тишину. Она струилась из тёмных углов комнаты, стекала с полок за барной стойкой. Она исходила от меча, висевшего над камином, и от лютни, стоявшей в углу. Это была тишина ожидания, тишина вещей, затаивших дыхание.

Третья тишина принадлежала человеку за барной стойкой. Она была самой тяжёлой из всех. Она лежала на его плечах, как ярмо, окутывала его, как одеяло из свинца. Это была тишина человека, который ждёт смерти.""",
            
            """Близился рассвет. В трактире «Путеводный камень» царила тишина, и была она из трёх частей.

Первая часть - тишина отсутствия. Ни шагов на дороге, ни стука в дверь, ни голосов путников. Мир за стенами словно перестал существовать.

Вторая - тишина самого трактира. Потемневшее дерево хранило молчание столетий. Бутылки на полках стояли неподвижно, как стражи. Даже пыль в воздухе замерла.

Третья тишина была живой. Она дышала вместе с рыжеволосым человеком, что сидел у окна. Она была частью его, как тень - часть предмета, её отбрасывающего.""",
            
            """Полночь. Трактир «Путеводный камень» утонул в тишине трёх видов.

Первая была проста - тишина спящего дома. Ни скрипа половиц, ни шороха занавесок.

Вторая таилась глубже - в тенях под лестницей, в пространстве между словами, в паузах между ударами сердца.

Третья же тишина была самой глубокой. Она жила в груди трактирщика, как зверь в клетке. Иногда она ворочалась, и тогда его зелёные глаза темнели, становясь почти чёрными."""
        ]
    
    @staticmethod
    def get_character_voice(character: CharacterProfile) -> str:
        patterns = "\n".join(f"- {pattern}" for pattern in character.speech_patterns)
        relationships = "\n".join(f"- {name}: {rel}" for name, rel in character.relationships.items())
        goals = "\n".join(f"- {goal}" for goal in character.goals)
        
        return f"""Пиши диалог для персонажа {character.name}.

РОЛЬ: {character.role}

ЛИЧНОСТЬ: {character.personality}

РЕЧЕВЫЕ ПАТТЕРНЫ:
{patterns}

ТЕКУЩЕЕ СОСТОЯНИЕ: {character.current_state}

ЦЕЛИ:
{goals}

ОТНОШЕНИЯ:
{relationships}

ВАЖНО: Диалог должен отражать личность и текущее эмоциональное состояние персонажа."""
    
    @staticmethod
    def get_magic_sympathy_prompt() -> str:
        return """Опиши использование симпатической магии.

ПРИНЦИПЫ СИМПАТИИ:
1. Принцип соответствия - подобное влияет на подобное
2. Принцип сохранения - энергия не появляется из ниоткуда
3. Принцип взаимности - сила связи зависит от сходства

КЛЮЧЕВЫЕ КОНЦЕПЦИИ:
- Алар: непоколебимая вера, "разум, расколотый надвое"
- Связывание: создание симпатической связи между объектами
- Источник энергии: тепло тела, огонь, движение
- Потери при переносе: неэффективность связей
- Гипотермия от перерасхода

ОПИСЫВАЙ:
- Физические ощущения (холод при использовании тепла тела)
- Ментальное напряжение удержания алара
- Технические детали (проценты эффективности)
- Последствия и ограничения"""
    
    @staticmethod
    def get_magic_naming_prompt() -> str:
        return """Опиши использование магии Именования.

ПРИРОДА ИМЕНОВАНИЯ:
- Понимание истинной сути вещи
- Знание истинного имени даёт власть
- Связано с глубоким пониманием, не заучиванием
- Приходит в моменты прозрения или сильных эмоций

ИЗВЕСТНЫЕ ИМЕНА:
- Ветер (самое важное для Квоута)
- Огонь
- Камень
- Железо
- Дерево
- Вода

ОПИСЫВАЙ:
- Момент прозрения/понимания
- Изменение восприятия мира
- Ощущение связи с называемым элементом
- Поэтичные, мистические описания
- Связь с эмоциональным состоянием

СТИЛЬ: Более лирично и загадочно, чем симпатия. Это древняя, интуитивная магия."""
    
    @staticmethod
    def get_denna_scene_prompt() -> str:
        return """Пиши сцену с Денной.

ДЕННА - КЛЮЧЕВЫЕ ЧЕРТЫ:
- Загадочная, независимая, неуловимая
- Красивая, но не традиционно (тёмные волосы, изящная)
- Умная, остроумная, начитанная
- Музыкально одарённая (голос, арфа)
- Постоянно меняет имена (Дианна, Дайанн, Алора и т.д.)
- Скрывает свою боль за улыбкой

ДИНАМИКА С КВОУТОМ:
- Взаимное притяжение и непонимание
- Оба боятся открыться
- Постоянно расходятся в разные стороны
- Квоут идеализирует её, но также видит её силу
- Денна ценит в нём то, что он видит в ней равную

ТИПИЧНЫЕ СЦЕНЫ:
- Случайные встречи в неожиданных местах
- Прогулки и философские разговоры
- Музыкальные импровизации
- Моменты почти-признаний
- Недопонимания и расставания

НАСТРОЕНИЕ: Горько-сладкое, полное несказанных слов и упущенных возможностей."""
    
    @staticmethod
    def get_chandrian_prompt() -> str:
        return """Пиши о Чандрианах - древних существах, убивших семью Квоута.

ЧАНДРИАНЕ - СЕМЕРО:
- Хэлиакс/Лантре - лидер, окутан тенью
- Циндер - жестокий, с белыми глазами
- Остальные пятеро (имена опасно произносить)

ПРИЗНАКИ ПРИСУТСТВИЯ:
- Синее пламя свечей
- Ржавеющее железо
- Гниющее дерево
- Холод
- Тишина
- Животные замолкают

ТАБУ:
- Их истинные имена нельзя произносить
- Истории о них привлекают их внимание
- Они появляются, чтобы уничтожить свидетельства о себе

ТАЙНА:
- Их истинная природа неизвестна
- Связаны с древней историей мира
- Возможно, прокляты или наказаны
- Ищут что-то или кого-то

АТМОСФЕРА: Древний ужас, неотвратимость, тайна тысячелетий."""
    
    @staticmethod
    def get_university_prompt() -> str:
        return """Пиши сцену в Университете.

УНИВЕРСИТЕТ - СТРУКТУРА:
- Медика (медицина)
- Симпатия (магия связей)
- Искусственное (инженерия, сигилдрия)
- Алхимия
- Риторика и логика
- Математика
- Архивы (величайшая библиотека)

КЛЮЧЕВЫЕ МЕСТА:
- Архивы (царство Мастера Лорена)
- Рыбный дворик (кабинеты мастеров)
- Холмы (общежития)
- Сломанная лестница (опасное место)
- Имре (город через реку)

ПЕРСОНАЖИ:
- Мастер Элодин (именование, эксцентричен)
- Мастер Килвин (искусственное, сеноран)
- Мастер Хэмм (симпатия, суров)
- Мастер Лорен (архивариус, педантичен)
- Симмон (лучший друг, добрый)
- Виллем (друг, спокойный)
- Амброз Якис (враг, богатый и жестокий)

АТМОСФЕРА: Академическая, но с опасностью. Знание - сила, но оно имеет цену."""
    
    @staticmethod
    def create_chapter_opening(
        narrative_type: str = "frame",
        time_of_day: str = "night",
        mood: str = "mysterious"
    ) -> str:
        if narrative_type == "frame":
            prompt = f"""Начни новую главу рамочного повествования.
            
Время суток: {time_of_day}
Настроение: {mood}

Начни с вариации описания тишины из трёх частей.
Затем плавно перейди к действию в трактире.
Помни о контрасте между текущим Коутом и его легендарным прошлым."""
        else:
            prompt = f"""Начни новую главу от лица Квоута.

Настроение: {mood}

Можешь начать с:
- Размышления о прошедших событиях
- Обращения к Хроникёру/читателю
- Погружения сразу в действие
- Философского отступления

Сохраняй голос Квоута - умный, самоироничный, поэтичный."""
        
        return prompt
    
    @staticmethod
    def create_continuation_prompt(
        previous_text: str,
        direction_hint: Optional[str] = None,
        target_length: int = 2000
    ) -> str:
        prompt = f"""Продолжи следующий текст в стиле Патрика Ротфусса:

{previous_text[-3000:]}  # Последние 3000 символов для контекста

{"Направление развития: " + direction_hint if direction_hint else ""}

Целевая длина продолжения: примерно {target_length} слов.

ВАЖНО:
- Сохраняй тот же тип повествования (рамочное/внутреннее)
- Поддерживай тот же тон и настроение
- Развивай начатые сюжетные линии
- Не делай резких переходов"""
        
        return prompt
    
    @staticmethod
    def create_scene_transition_prompt(
        from_scene: str,
        to_scene: str,
        transition_type: str = "smooth"
    ) -> str:
        transitions = {
            "smooth": "Сделай плавный переход",
            "chapter_break": "Заверши текущую сцену и начни новую главу",
            "time_jump": "Сделай временной прыжок",
            "perspective_shift": "Смени тип повествования (рамочное/внутреннее)",
            "cliffhanger": "Заверши на интригующей ноте"
        }
        
        return f"""Создай переход между сценами.

ИЗ: {from_scene}
В: {to_scene}

ТИП ПЕРЕХОДА: {transitions.get(transition_type, transition_type)}

Сохраняй стилистику Ротфусса. Если меняется тип повествования, четко обозначь это сменой голоса и времени."""
    
    @staticmethod
    def generate_book_three_outline() -> str:
        return """СТРУКТУРА "ДВЕРЕЙ КАМНЯ" - ПЛАН:

ЧАСТЬ 1: РАЗБИТОЕ МОЛЧАНИЕ
Главы 1-20: Возвращение силы
- Рамка: Угроза приближается к трактиру
- История: Изгнание из Университета, путешествие в Винтас
- Раскрытие: Истинная природа Дверей Камня

ЧАСТЬ 2: ИМЯ ВСЕХ ВЕЩЕЙ
Главы 21-40: Поиски Чандриан
- Рамка: Коут начинает проявлять свою силу
- История: Обучение у Темпи завершено, поиски Чандриан
- Кульминация: Первая настоящая встреча с Чандрианами

ЧАСТЬ 3: ЦЕНА МУДРОСТИ
Главы 41-60: Восхождение к легенде
- Рамка: Баст раскрывает свои планы
- История: Квоут становится Кровавым, убийство короля
- Откровение: Связь Денны с Чандрианами

ЧАСТЬ 4: ПОСЛЕДНЯЯ ТИШИНА
Главы 61-75: Падение
- Рамка: Битва в настоящем времени
- История: Потеря силы, "смерть" Квоута, рождение Коута
- Финал: Выбор между легендой и человечностью

ЭПИЛОГ: НОВАЯ ПЕСНЬ
- Разрешение обеих временных линий
- Намёк на будущее"""