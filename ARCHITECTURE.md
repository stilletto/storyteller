# Архитектура системы Storyteller

## Обзор проекта
Система для генерации третьей книги серии "Хроники убийцы короля" Патрика Ротфусса - "Двери камня" с использованием Claude Neptune v4.

## Основные компоненты

### 1. Core Engine (src/core/)
- **StoryEngine**: Центральный координатор генерации
- **NarrativeController**: Управление двойной структурой повествования (рамочное/внутреннее)
- **SessionManager**: Управление состоянием и контекстом генерации

### 2. AI Integration (src/ai/)
- **ClaudeNeptuneClient**: Обертка для API Claude Neptune v4
- **PromptBuilder**: Конструктор промптов с учетом стиля Ротфусса
- **ResponseProcessor**: Обработка и валидация ответов AI
- **ContextManager**: Управление контекстом (до 200k токенов)

### 3. Style Analysis (src/style/)
- **StyleAnalyzer**: Анализ стилистических паттернов из оригинальных текстов
- **VocabularyManager**: База характерных слов и выражений
- **RhythmAnalyzer**: Анализ ритма и структуры предложений
- **MetaphorBank**: База метафор и сравнений автора

### 4. Story Management (src/story/)
- **PlotTracker**: Отслеживание сюжетных линий и их развития
- **CharacterManager**: Управление персонажами и их арками
- **WorldStateManager**: Состояние мира и внутренняя логика
- **TimelineController**: Управление временными линиями (прошлое/настоящее)
- **ChapterPlanner**: Планирование структуры глав

### 5. Content Validation (src/validation/)
- **ConsistencyChecker**: Проверка внутренней согласованности
- **StyleValidator**: Проверка соответствия стилю автора
- **LoreValidator**: Проверка соответствия установленному миру
- **QualityEvaluator**: Оценка качества сгенерированного текста

### 6. Templates & Prompts (src/templates/)
- **FrameNarrativeTemplates**: Шаблоны для рамочного повествования
- **InnerNarrativeTemplates**: Шаблоны для истории Квоута
- **SilenceDescriptions**: База описаний тишины
- **MagicSystemPrompts**: Промпты для систем магии (симпатия/именование)

### 7. Data Management (src/data/)
- **BookLoader**: Загрузка и парсинг существующих книг
- **CharacterDatabase**: База данных персонажей
- **EventDatabase**: База событий и их последствий
- **LocationDatabase**: База локаций и их описаний

### 8. Output Processing (src/output/)
- **ChapterFormatter**: Форматирование глав
- **ExportManager**: Экспорт в различные форматы (txt, epub, pdf)
- **VersionControl**: Управление версиями генерации

### 9. User Interface (src/ui/)
- **CLI Interface**: Командный интерфейс
- **Web Dashboard**: Веб-интерфейс для управления
- **ProgressTracker**: Отслеживание прогресса генерации

## Workflow генерации

### Фаза 1: Инициализация
1. Загрузка существующих книг
2. Анализ стиля и построение моделей
3. Создание базы знаний о мире и персонажах
4. Инициализация контекста для третьей книги

### Фаза 2: Планирование
1. Создание общей структуры книги
2. Планирование основных сюжетных точек
3. Распределение арок персонажей
4. Определение ключевых откровений

### Фаза 3: Генерация
1. **Итеративная генерация глав**:
   - Генерация рамочного повествования
   - Генерация внутреннего повествования
   - Интеграция двух уровней
   
2. **Для каждой сцены**:
   - Определение контекста и целей
   - Генерация диалогов
   - Добавление описаний и действий
   - Проверка согласованности

### Фаза 4: Валидация и редактирование
1. Проверка внутренней логики
2. Проверка соответствия стилю
3. Проверка развития персонажей
4. Редактирование и полировка

### Фаза 5: Финализация
1. Форматирование текста
2. Создание оглавления
3. Экспорт в целевые форматы
4. Сохранение метаданных генерации

## Ключевые особенности системы

### 1. Двухуровневое повествование
- Автоматическое переключение между рамочным и внутренним повествованием
- Поддержание напряжения в обоих временных линиях
- Синхронизация откровений между уровнями

### 2. Стилистическая точность
- Воспроизведение "тишины из трех частей"
- Использование характерных метафор и сравнений
- Поддержание музыкальности языка
- Правильное использование систем магии

### 3. Управление сложностью
- Отслеживание множественных сюжетных линий
- Управление тайнами и их раскрытием
- Поддержание баланса между действием и рефлексией

### 4. Интеллектуальная генерация
- Использование thinking mode для планирования
- Контекстное окно до 200k токенов
- Адаптивная температура для разных типов контента

## Технические требования

### Минимальные требования
- Python 3.10+
- 16GB RAM
- 50GB свободного места
- Стабильное интернет-соединение

### Рекомендуемые требования
- Python 3.11+
- 32GB RAM
- 100GB SSD
- GPU для локального анализа текста

## Безопасность и контроль

### 1. Защита данных
- Шифрование API ключей
- Локальное хранение сгенерированного контента
- Резервное копирование прогресса

### 2. Контроль качества
- Многоуровневая валидация
- Человеческий контроль критических моментов
- Возможность отката изменений

### 3. Этические соображения
- Уважение к оригинальному автору
- Маркировка как AI-generated контент
- Некоммерческое использование

## Расширяемость

### Поддерживаемые расширения
- Добавление новых стилистических анализаторов
- Интеграция дополнительных AI моделей
- Плагины для специфических жанровых элементов
- Кастомные валидаторы и процессоры

### API для разработчиков
- REST API для внешних интеграций
- Webhook'и для уведомлений о прогрессе
- SDK для создания расширений

## Метрики успеха

### Качественные метрики
- Соответствие стилю автора (>90%)
- Внутренняя согласованность (100%)
- Удовлетворенность читателей тестовой группы

### Количественные метрики
- Скорость генерации (1000 слов/час)
- Процент принятого контента (>80%)
- Количество требуемых правок (<20%)

## Roadmap развития

### v1.0 - MVP
- Базовая генерация текста
- Простой CLI интерфейс
- Основные валидаторы

### v2.0 - Enhanced
- Веб-интерфейс
- Улучшенный анализ стиля
- Расширенное управление сюжетом

### v3.0 - Professional
- Мультиязычная поддержка
- Коллаборативное редактирование
- AI-ассистированное планирование сюжета

## Критические точки успеха

1. **Сохранение голоса Квоута** - первое лицо, саморефлексия, ирония
2. **Баланс тайны и откровения** - постепенное раскрытие информации
3. **Эмоциональная достоверность** - глубина чувств и мотиваций
4. **Мифологическая целостность** - согласованность с установленным миром
5. **Удовлетворительное завершение** - разрешение всех основных конфликтов